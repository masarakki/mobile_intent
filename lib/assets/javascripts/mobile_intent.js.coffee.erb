class MobileIntent
  @detect: (ua) ->
    switch
      when ua.match /Android/ then "android"
      when ua.match /i(Phone|Pad)/ then "ios"

<% MobileIntent.config.apps.each_pair do |name, app| %>
  @<%= name %> = {
    <% [:ios, :android].map do |platform| %>
      <%= "#{platform}: '#{app.market_url(platform)}'" if app.send("#{platform}?") %>
    <% end %>
  }
<% end %>


$(document).ready ->
  $(".launch_app").on 'click', (e) ->
    target = $(e.target)
    app = target.attr "data-app-scheme"
    platform = MobileIntent.detect window.navigator.userAgent
    if market_url = MobileIntent[app][platform]
      iframe = $("<iframe>").attr("id", "launch_app").css {
        visibility: "hidden",
        width: '0px',
        height: '0px'
      }
      iframe.attr "src", target.attr("href")
      $("body").append(iframe)
      start_at = new Date().getTime()
      setTimeout ->
        now = new Date().getTime()
        $("body").remove("#launch_app")
        window.location = market_url unless now - start_at > 600
      , 500

